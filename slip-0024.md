# SLIP-0024 : Trezor payment request format

```
Number:  SLIP-0024
Title:   Trezor payment request format
Type:    Standard
Status:  Draft
Authors: Andrew Kozlik <andrew.kozlik@satoshilabs.com>
Created: 2021-12-09
```

## Abstract

A Trezor payment request is a message that is signed by a trusted party requesting payment of a specified amount to one or more addresses, similar in principle to [BIP-70](https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki).
This message can be processed by a payer's wallet in such a way that the payer does not have to inspect the destination address and only needs to confirm the payment of the requested amount to the recipient that is named in the payment request.

## Motivation

When making a Bitcoin payment the recipient of the payment needs to securely communicate their Bitcoin address to the payer. If the communication channel between the two parties is not well secured or if one of the endpoints is compromised by malware, then an attacker may modify the address, changing it to the attacker's own address in order to receive the payment instead of the legitimate recipient. This type of attack is known as *address spoofing*.

Hardware wallets are known to be the most secure solution to cryptocurrency payments. They are generally very resilient to malware, but they do not protect the payer from address spoofing outside of the wallet. The task of authenticating the address is up to the payer who should ideally verify the correctness of the address by means of a second channel. Using multiple channels to communicate the address reduces the likelihood of an attacker being able to compromise all of them at once, but at the same time it hinders the user experience.

This specification defines a new format for payment requests which 

This designed for the needs of hardware wallets but does not rule out use by other applications.
Earlier [BIP-70](https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki)

## Differences over BIP-70

* Caters to the needs of hardware wallets, e.g. uses a nonce challenge instead of creation/expiry time.
* PKI is considered out of scope, thus X.509 support is not required.
* Designed for use with any cryptocurrency.
* Signature is required.
* New types of memo fields.

## Payment request items

### Recipient name

The name that is shown to the payer instead of the address or addresses which the payment request represents.
The payer should have the option of inspecting the addresses.

### Memos

Memos are used to provide additional information to the payer about the purpose of the payment request. They may contain information that needs to be verified by the payer 

#### Text memo

A UTF-8 encoded, plain-text note that should be displayed to the payer, explaining the purpose of the payment request.

### Nonce

A unique challenge generated by the payer's wallet. The nonce guarantees freshness of the payment request and prevents replaying the payment request to the wallet. A nonce is required whenever memos are present in the payment request.

### Signature

A digital signature of the payment request issued by a party which is trusted by the payer.

### Address authentication code

Let *k* be a secret *address authentication key* derived from the wallet's master secret using the [SLIP-0021](https://github.com/satoshilabs/slips/blob/master/slip-0021.md) method for hierarchical derivation of symmetric keys as:

```
k = Key(m/"SLIP-0024"/"Address MAC key")
```

The address authentication code is computed as:

```
mac = HMAC-SHA256(key = k, msg = coinType || address)
```
where `coinType || address` is the concatenation of the following fields:

* *coinType* (4 bytes): 32-bit encoding of the SLIP-0044 coin type of the address in little-endian byte order.
* *address* (length-prefixed string): the address being authenticated.

### Payment request signature

A hash of the payment request is signed using the private key of the trusted party.
The default signature scheme is ECDSA with SHA-256 and the curve secp256k1, but any other suitable signature scheme may be used instead.

The hash of the payment request is computed by taking the concatenation of the following fields:

* *versionMagic* (4 bytes): b"\x53\x4c\x00\x24" (this is "SL" followed by 0024 in compressed numeric form as an abbreviation for "SLIP-0024").
* *nonce* (length-prefixed binary string): an optional nonce challenge from the wallet. If a nonce is not used, then a zero-length string should be provided.
* *recipientName* (length-prefixed UTF-8 string): a human-readable string identifying the recipient of the payment.
* *n* (VarInt): the number of memos which follow. The VarInt MUST be encoded in the fewest possible number of bytes.
* *memo*<sub>1</sub> || *memo*<sub>2</sub> || ... || *memo*<sub>*n*</sub> (variable length): concatenation of the binary encoding of the memos.
* *coinType* (4 bytes): 32-bit encoding of the SLIP-0044 coin type of the outputs in little-endian byte order.
* *outputsHash* (32 bytes): the SHA-256 of the binary encodings of all requested outputs.

A text memo is encoded as the concatenation of the following fields:

* *memoType* (4 bytes): b"\x00\x00\x00\x00".
* *text* (length-prefixed UTF-8 string): a human-readable string providing information about the purpose of the payment.

A coin purchase memo is encoded as follows:

* *memoType* (4 bytes): b"\x01\x00\x00\x00" (32-bit encoding of the integer 1 in little-endian byte order).
* *coinType* (4 bytes): 32-bit encoding of the SLIP-0044 coin type that will be delivered in little-endian byte order.
* *amount* (8 bytes): 64-bit encoding of the amount that will be delivered in little-endian byte order.
* *address* (length-prefixed string): the address where the coin purchase will be delivered.

The value of *outputsHash* is computed as the SHA-256 hash of the concatenation of the binary encodings of the requested outputs. The binary encoding of an output is the concatenation of the following fields:

* *amount* (8 bytes): 64-bit encoding of the amount of the requested output in little-endian byte order.
* *address* (length-prefixed string): the address of the requested output.

## Test vectors

TODO

## References

* [BIP-0070](https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki): Payment Protocol
